using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AutoMapper;
using Microsoft.AspNetCore.Http;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.ChangeTracking;
using Samr.ERP.Core.Interfaces;
using Samr.ERP.Core.Models;
using Samr.ERP.Core.Models.ErrorModels;
using Samr.ERP.Core.Models.ResponseModels;
using Samr.ERP.Core.Stuff;
using Samr.ERP.Core.ViewModels.Account;
using Samr.ERP.Core.ViewModels.Employee;
using Samr.ERP.Core.ViewModels.Handbook;
using Samr.ERP.Infrastructure.Data;
using Samr.ERP.Infrastructure.Data.Contracts;
using Samr.ERP.Infrastructure.Entities;
using Samr.ERP.Infrastructure.Providers;

namespace Samr.ERP.Core.Services
{
    public class EmployeeService : IEmployeeService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IUserService _userService;
        private readonly UserProvider _userProvider;
        private readonly IMapper _mapper;
        private readonly IUploadFileService _file;

        public EmployeeService(
            IUnitOfWork unitOfWork,
            IUserService userService,
            UserProvider userProvider,
            IMapper mapper,
            IUploadFileService file
<<<<<<< HEAD
            )
        {
            _unitOfWork = unitOfWork;
            _userService = userService;
            _userProvider = userProvider;
=======
>>>>>>> parent of 3a91a86... Merge branch 'dev' of https://bitbucket.org/migdev/samr-erp into dev
            )
        {
            _unitOfWork = unitOfWork;
            _userService = userService;
            _userProvider = userProvider;
            _mapper = mapper;
            _file = file;
        }

        public async Task<BaseDataResponse<GetEmployeeViewModel>> GetByIdAsync(Guid id)
        {
            BaseDataResponse<GetEmployeeViewModel> dataResponse;

            var employee = await _unitOfWork.Employees.GetDbSet()
                .Include( p => p.User)
                .Include(p => p.CreatedUser)
                .Include( p => p.Position)
                .Include( p => p.Position.Department)
                .Include(p => p.Gender)
                .Include(p => p.EmployeeLockReason)
                .FirstOrDefaultAsync(p => p.Id == id);

            if (employee == null)
            {
                dataResponse = BaseDataResponse<GetEmployeeViewModel>.NotFound(null);
            }
            else
            {
                dataResponse = BaseDataResponse<GetEmployeeViewModel>.Success(_mapper.Map<GetEmployeeViewModel>(employee));
            }

            return dataResponse;
        }

        public async Task<BaseDataResponse<PagedList<AllEmployeeViewModel>>> AllAsync(PagingOptions pagingOptions, FilterEmployeeViewModel filterEmployeeViewModel)
        {
            var query = _unitOfWork.Employees
                .GetDbSet()
                .Include(p => p.CreatedUser)
                .Include(p => p.Position)
                .Include(p => p.Position.Department)
                .Include(p => p.LockUser)
                .Include(p => p.User)
                .Where(e => e.EmployeeLockReasonId == null);

            if (filterEmployeeViewModel.FullName != null)
                query = query.Where(e => filterEmployeeViewModel.FullName.Contains(e.FirstName)
                                         || filterEmployeeViewModel.FullName.Contains(e.LastName)
                                         || filterEmployeeViewModel.FullName.Contains(e.MiddleName));

            if (filterEmployeeViewModel.DepartmentId != null)
                query = query.Where(e => e.Position.DepartmentId == filterEmployeeViewModel.DepartmentId);

            if (filterEmployeeViewModel.HasUser)
                query = query.Where(e => e.UserId != null);

            var pagedList =  await query.ToMappedPagedListAsync<Employee, AllEmployeeViewModel>(pagingOptions);

            return BaseDataResponse<PagedList<AllEmployeeViewModel>>.Success(pagedList);
        }

        public async Task<BaseDataResponse<EditEmployeeViewModel>> CreateAsync(EditEmployeeViewModel editEmployeeViewModel)
        {
            BaseDataResponse<EditEmployeeViewModel> dataResponse;

            // TODO Raha
            //var filePathName = await _file.StorePhoto("wwwroot/employers", filePath);
            //dataResponse = BaseDataResponse<EditEmployeeViewModel>.Success(editEmployeeViewModel);

            var employeeExists = _unitOfWork.Employees.Any(predicate: e => 
                e.Phone.ToLower() == editEmployeeViewModel.Phone.ToLower() &&
                e.Email.ToLower() == editEmployeeViewModel.Email.ToLower()
            );

            if (employeeExists)
            {
                dataResponse = BaseDataResponse<EditEmployeeViewModel>.Fail(editEmployeeViewModel, new ErrorModel("Phone number already exists"));

            }
            else
            {

                var employee = _mapper.Map<Employee>(editEmployeeViewModel);
                _unitOfWork.Employees.Add(employee);
                await _unitOfWork.CommitAsync();

                dataResponse = BaseDataResponse<EditEmployeeViewModel>.Success(_mapper.Map<EditEmployeeViewModel>(employee));
            }

            return dataResponse;
        }

        public async Task<BaseDataResponse<UserViewModel>> CreateUserForEmployee(Guid employeeId)
        {
            var employee = await _unitOfWork.Employees.GetByIdAsync(employeeId);

            if (employee == null)
                return BaseDataResponse<UserViewModel>.NotFound(null);

            var user = new User()
            {
                UserName = employee.Phone,
                Email = employee.Email,
                PhoneNumber = employee.Phone
            };

            var createUserResult = await _userService.CreateAsync(user, PasswordGenerator.GenerateNewPassword());

            if (!createUserResult.Succeeded)
                return BaseDataResponse<UserViewModel>.Fail(null, createUserResult.Errors.ToErrorModels());

            employee.UserId = user.Id;

            await _unitOfWork.CommitAsync();
            await _emailSender.SendEmailToEmployeeAsync(user, "Reset password", $"Your account pass was reset, new pass {generateNewPassword}");

            return BaseDataResponse<UserViewModel>.Success(_mapper.Map<UserViewModel>(user));

        }

        public async Task<BaseDataResponse<EditEmployeeViewModel>> EditAsync(EditEmployeeViewModel editEmployeeViewModel)
        {
            BaseDataResponse<EditEmployeeViewModel> dataResponse;

            var employeExists = await _unitOfWork.Employees.GetDbSet().FirstOrDefaultAsync( e => e.Id == editEmployeeViewModel.Id);

            if (employeExists == null)
            {
                dataResponse = BaseDataResponse<EditEmployeeViewModel>.NotFound(editEmployeeViewModel, new ErrorModel("Not found employee"));
            }
            else
            {
                var existsUser = await _unitOfWork
                    .Employees
                    .GetDbSet()
                    .Where(p => p.Id == editEmployeeViewModel.Id && p.UserId != null)
                    .Select(p => p.User)
                    .FirstOrDefaultAsync();

                if (existsUser != null)
                {
                    existsUser.Email = editEmployeeViewModel.Email;

                    _unitOfWork.Users.Update(existsUser);
                }

                var checkEmailUnique = await _unitOfWork.Employees
                    .GetDbSet()
                    .AnyAsync(e => e.Id != editEmployeeViewModel.Id
                                   && e.Phone.ToLower() == editEmployeeViewModel.Phone.ToLower());
                if (checkEmailUnique)
                {
                    dataResponse = BaseDataResponse<EditEmployeeViewModel>.Fail(editEmployeeViewModel, new ErrorModel("Duplicate phone number!"));
                }
                else
                {
                    var employee = _mapper.Map<EditEmployeeViewModel, Employee>(editEmployeeViewModel, employeExists);

                    _unitOfWork.Employees.Update(employee);

                    await _unitOfWork.CommitAsync();

                    dataResponse = BaseDataResponse<EditEmployeeViewModel>.Success(_mapper.Map<EditEmployeeViewModel>(employee));
                }
            }

            return dataResponse;
        }

        public async Task<BaseResponse> EditUserDetailsAsync(
            EditUserDetailsViewModel editUserDetailsView)
        {
            var userExists = await _unitOfWork.Users.ExistsAsync(editUserDetailsView.UserId);

            if (!userExists)
                return BaseResponse.NotFound();

            var employee = await _unitOfWork.Employees.All().FirstOrDefaultAsync(x => x.UserId == editUserDetailsView.UserId);

            employee.Email = editUserDetailsView.Email;
            employee.FactualAddress = editUserDetailsView.FactualAddress;

            await EditAsync(_mapper.Map<EditEmployeeViewModel>(employee));

            return BaseResponse.Success();
        }

        public async Task<BaseResponse> LockEmployeeAsync(LockEmployeeViewModel lockEmployeeViewModel)
        {
            var employee = await _unitOfWork.Employees.GetDbSet()
                .Include(p => p.User)
                .FirstOrDefaultAsync(p => p.Id == lockEmployeeViewModel.EmployeeId);

            var employeeLockReason =
                await _unitOfWork.EmployeeLockReasons.GetByIdAsync(lockEmployeeViewModel.EmployeeLockReasonId);

            if (employee == null
                || employeeLockReason == null
                || !employeeLockReason.IsActive
                || employee.EmployeeLockReasonId != null) return BaseResponse.NotFound();

            employee.LockUserId = _userProvider.CurrentUser.Id;
            employee.EmployeeLockReasonId = employeeLockReason.Id;
            employee.LockDate = DateTime.Now;
            
            await _unitOfWork.CommitAsync();

            return BaseResponse.Success();
        }

        public async Task<BaseResponse> UnLockEmployeeAsync(Guid employeeId)
        {
            
            var employee = await _unitOfWork.Employees.GetDbSet()
                .Include(p => p.User)
                .FirstOrDefaultAsync(p => p.Id == employeeId);

            if (employee?.EmployeeLockReasonId == null) return BaseResponse.NotFound();

            //TODO LockUnlockUser
            employee.LockUserId = null;
            employee.EmployeeLockReasonId = null;
            employee.LockDate = null;

            await _unitOfWork.CommitAsync();

            return BaseResponse.Success();
        }

        public async Task<BaseDataResponse<GetPassportDataEmployeeViewModel>> GetPassportDataAsync(Guid employeeId)
        {
            BaseDataResponse<GetPassportDataEmployeeViewModel> dataResponse;

            var passportDataAsync = await _unitOfWork.Employees.GetDbSet()
                .Include(p => p.Nationality)
                .FirstOrDefaultAsync(p => p.Id == employeeId);
            if (passportDataAsync == null)
            {
                dataResponse = BaseDataResponse<GetPassportDataEmployeeViewModel>.NotFound(null, new ErrorModel("Not found employee"));
            }
            else
            {
                dataResponse = BaseDataResponse<GetPassportDataEmployeeViewModel>.Success(_mapper.Map<GetPassportDataEmployeeViewModel>(passportDataAsync));
            }

            return dataResponse;
        }

        public async Task<BaseDataResponse<PagedList<AllLockEmployeeViewModel>>> GetAllLockedEmployeeAsync(PagingOptions pagingOptions)
        {
            var query = _unitOfWork.Employees
                .GetDbSet()
                .Include(p => p.CreatedUser)
                .Include(p => p.Position)
                .Include(p => p.Position.Department)
                .Include(u => u.LockUser)
                .Include(p => p.EmployeeLockReason)
                .Where(e => e.EmployeeLockReasonId != null);

            var itemList = await query.ToMappedPagedListAsync<Employee, AllLockEmployeeViewModel>(pagingOptions);

            return BaseDataResponse<PagedList<AllLockEmployeeViewModel>>.Success(itemList);
        }

        public async Task<BaseResponse> EditPassportDataAsync(EditPassportDataEmployeeViewModel editPassportDataEmployeeViewModel)
        {
            BaseResponse response;

            var existEmployee = await _unitOfWork.Employees.GetDbSet().FirstOrDefaultAsync( e=> e.Id == editPassportDataEmployeeViewModel.EmployeeId);

            if (existEmployee != null)
            {
                var passportDataEmployee = _mapper.Map<EditPassportDataEmployeeViewModel, Employee>(editPassportDataEmployeeViewModel, existEmployee);

                _unitOfWork.Employees.Update(passportDataEmployee);

                await _unitOfWork.CommitAsync();

                response = BaseResponse.Success();
            }
            else
            {
                response = BaseResponse.NotFound();
            }

            return response;
        }
    }
}